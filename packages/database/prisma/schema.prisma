//
// Autogenerated by `prisma-import`
// Any modifications will be overwritten on subsequent runs.
//

//
// _base.prisma
//

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// _enums.prisma
//

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CompanyRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
}

enum SystemRole {
  SUPER_ADMIN // Permissão total sobre o sistema.
  STAFF // Acesso geral ao painel de administração.
  BILLING // Acesso apenas a módulos financeiros.
  SUPPORT // Acesso apenas a módulos de suporte.
}

enum ContactType {
  GENERAL
  BILLING
  TECHNICAL
}

enum NotificationType {
  BILLING // Faturas, lembretes de pagamento, confirmações.
  SUPPORT // Atualizações de tickets de suporte.
  MARKETING // Newsletters, promoções, anúncios.
  GENERAL // Anúncios gerais de serviço, manutenções.
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN_SUCCESS
  LOGIN_FAILURE
}

//
// accounts.prisma
//

// Module: Accounts & Access
// Defines the entities that govern authentication, authorization, and user permissions.

// The User model represents an individual who can log in and operate the system.
model User {
  id           String      @id @default(uuid())
  email        String      @unique
  name         String
  phone        String?
  passwordHash String?     @map("password_hash")
  status       Status      @default(ACTIVE)
  systemRole   SystemRole? @map("system_role") // If not null, this user is an internal team member.

  // --- AUDIT FIELDS ADDED ---
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")
  updatedById String?  @map("updated_by_id")
  // --- END OF AUDIT FIELDS ---

  // Direct Relationships
  memberships          Membership[]
  notificationSettings UserNotificationSetting[]
  auditLogs            AuditLog[]

  // Self-referencing audit relationships
  createdBy    User?  @relation("CreatedUsers", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?  @relation("UpdatedUsers", fields: [updatedById], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("CreatedUsers")
  updatedUsers User[] @relation("UpdatedUsers")

  // Inverse audit relationships (actions this user has performed)
  createdContacts  Contact[] @relation("CreatedContacts")
  updatedContacts  Contact[] @relation("UpdatedContacts")
  createdCompanies Company[] @relation("CreatedCompanies")
  updatedCompanies Company[] @relation("UpdatedCompanies")
  // ... (we will add more here as we build other modules)

  @@map("users")
}

// Controls notification preferences for a specific user, overriding company settings.
model UserNotificationSetting {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  type      NotificationType // The type of notification (e.g., BILLING, SUPPORT)
  channel   NotificationChannel // The channel (e.g., EMAIL, WHATSAPP)
  isEnabled Boolean             @default(true) @map("is_enabled") // Is this notification active?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensures only one setting exists per user, type, and channel combination.
  @@unique([userId, type, channel])
  @@map("user_notification_settings")
}

// The Membership model is the "glue" that links a client User to a Company.
model Membership {
  userId    String      @map("user_id")
  companyId String      @map("company_id")
  role      CompanyRole @default(MEMBER)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Defines a composite primary key, ensuring a user can only be added to a company once.
  @@id([userId, companyId])
  @@map("memberships")
}

//
// audit.prisma
//

model AuditLog {
  id         String      @id @default(uuid())
  createdAt  DateTime    @default(now()) @map("created_at")
  // Quem realizou a ação?
  actorId    String?     @map("actor_id")
  actor      User?       @relation(fields: [actorId], references: [id], onDelete: SetNull)
  // Qual foi a ação?
  action     AuditAction
  // Sobre o que foi a ação? (Relação Polimórfica)
  targetType String      @map("target_type") // Ex: "Company", "Invoice", "User"
  targetId   String      @map("target_id") // O ID do registo alvo
  // Detalhes adicionais (ex: quais campos foram alterados, endereço IP do login, etc.)
  details    Json?

  @@map("audit_logs")
}

//
// clients.prisma
//

model Company {
  id                    String   @id @default(uuid())
  status                Status   @default(ACTIVE)
  name                  String
  taxId                 String   @unique @map("tax_id")
  municipalRegistration String?  @unique @map("municipal_registration")
  addressStreet         String?  @map("address_street")
  addressNumber         String?  @map("address_number")
  addressComplement     String?  @map("address_complement")
  addressNeighborhood   String?  @map("address_neighborhood")
  addressZipCode        String?  @map("address_zip_code")
  addressCity           String?  @map("address_city")
  addressState          String?  @map("address_state")
  addressCountry        String?  @default("Brasil") @map("address_country")
  // --- Inicio auditoria
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdById           String?  @map("created_by_id")
  updatedById           String?  @map("updated_by_id")
  createdBy             User?    @relation("CreatedCompanies", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy             User?    @relation("UpdatedCompanies", fields: [updatedById], references: [id], onDelete: SetNull)
  // --- Final auditoria

  memberships          Membership[]
  notificationSettings NotificationSetting[]
  contacts             Contact[]

  @@map("companies")
}

model Contact {
  id          String      @id @default(uuid())
  companyId   String      @map("company_id")
  type        ContactType
  fullName    String      @map("full_name")
  email       String
  phone       String?
  isPrimary   Boolean     @default(false) @map("is_primary")
  // --- Inicio auditoria
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  createdById String?     @map("created_by_id")
  updatedById String?     @map("updated_by_id")
  createdBy   User?       @relation("CreatedContacts", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?       @relation("UpdatedContacts", fields: [updatedById], references: [id], onDelete: SetNull)
  // --- Final auditoria

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, email])
  @@map("contacts")
}

model NotificationSetting {
  id        String              @id @default(uuid())
  companyId String              @map("company_id")
  type      NotificationType
  channel   NotificationChannel
  isEnabled Boolean             @default(true) @map("is_enabled")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, type, channel])
  @@map("notification_settings")
}

//
// schema.prisma
//
